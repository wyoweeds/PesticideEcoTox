---
title: Trends in honey bee toxicity of pesticides used in United States corn and soybean production
date: "updated `r Sys.Date()`"
output: html_document
---

---

Load data from files:

```{r setup, warning = FALSE, message = FALSE, results = 'hide'}
library("tidyverse")
library("cowplot")
library("readxl")
library("openxlsx")
library("plotly")
library("rcartocolor")
library("tidytext")


### Load Kynnetec AgroTrak pesticide data (proprietary):
AgroTrak.CornSoy.dat <- read_excel("AgroTrak_CornSoy_v1.xlsx",
                          skip = 5) %>%
  select(Year, Crop,
         Type = "Pesticide Type",
         Active.Ingredient = "Active Ingredient",
         Volume.lbs = "AI volume\r\n(lb)",
         Base.Area.Treated = "Base Area Treated\r\n(acres)") %>%
  mutate(ai = str_replace_all(Active.Ingredient, " \\(.\\)", "")) 
glimpse(AgroTrak.CornSoy.dat)

### Load concordance file:
srcTab <- read_csv("cclistInEcotox.csv")
glimpse(srcTab)

### Load honey bee toxicity values from ecotox export:
ecotox.dat0 <- 
  read_excel("ECOTOX-Terrestrial-Export_20211207_plusManualAdd.xlsx",
             sheet = "Terrestrial-Export") %>%
  rename(cas.number = "CAS Number", chemName = "Chemical Name") 
### Pare down ecotox values to those likely to be used in this analysis
### (leaving the full ecotox.dat0 just in case needed later),
### and join with the concordance list containing AgroTrak names:
ecotox.dat <- ecotox.dat0 %>%
  select(source,
         cas.number, 
         ConcType = `Conc 1 Type (Author)`,
         Effect, 
         LifeStage = `Organism Lifestage`,
         ExposureType = `Exposure Type`, 
         Endpoint, 
         ObservedDuration.d = `Observed Duration (Days)`,
         ObsRespMean = `Observed Response Mean`,
         ToxUnit = `Observed Response Units`) %>%
  filter(Endpoint %in% c("LD50", "NOEL")) %>%
  right_join(srcTab) %>%
  select(-inEcoTox, -inManualAdd, -CompTox.PREFERRED_NAME)
glimpse(ecotox.dat)  
```

Create a ranked list of pesticides by volume applied in AgroTrak:

```{r, warning = FALSE, message = FALSE, results = 'hide'}
AgroTrak.Ranked <- AgroTrak.CornSoy.dat %>%
  group_by(Type, ai) %>%
  summarize(Volume.lbs = round(sum(Volume.lbs, na.rm = TRUE)),
            Base.Area.Treated.sum = round(sum(Base.Area.Treated, 
                                              na.rm = TRUE)),
            nYears = length(unique(Year)),
            Base.Area.perYear = round(Base.Area.Treated.sum / nYears),
            Volume.perYear = round(Volume.lbs / nYears)) %>%
  arrange(Type, -Volume.lbs)
```

## Adult Contact LD50
```{r, warning = FALSE, message = FALSE, results = 'hide'}
AdultContactLD50 <- ecotox.dat %>%
  filter(LifeStage == "Adult" &
           ExposureType == "Dermal" & 
           Endpoint == "LD50") %>%
  group_by(ai) %>%
  mutate(checkAI = any(grepl("AI|ai|ae", ToxUnit)),
         hasAI = grepl("AI|ai|ae", ToxUnit)) %>%
  group_by(ai, hasAI) %>%
  mutate(min.d.grp = min(abs(2 - ObservedDuration.d) + 2, 
                         na.rm = TRUE)) %>%
  filter(case_when(checkAI == TRUE ~ 
                     hasAI == TRUE & ObservedDuration.d <= min.d.grp + 2,
                   checkAI == FALSE ~
                     ObservedDuration.d <= min.d.grp + 2)) %>%
  ungroup() %>%
  select(-checkAI, -hasAI, -min.d.grp) %>%
  group_by(ai) %>%
  slice(which.min(ObsRespMean))
glimpse(AdultContactLD50)
unique(AdultContactLD50$ConcType)
unique(AdultContactLD50$ToxUnit) 
AgroTrak.AdultContactLD50.Rank <- left_join(AgroTrak.Ranked, AdultContactLD50)
#write.xlsx(AgroTrak.AdultContactLD50.Rank,
#          file = "Draft_AdultContactLD50.xlsx", asTable = TRUE)

AdultContactLD50.summary <- AgroTrak.AdultContactLD50.Rank %>%
  group_by(Type) %>%
  mutate(totalVol = sum(Volume.lbs),
         pctVol = Volume.lbs / totalVol * 100,
         toxVal = !is.na(ObsRespMean)) %>%
  #select(Type, ai, Volume.lbs, totalVol, pctVol, toxVal)
  group_by(Type, toxVal) %>%
  summarize(toxPct = sum(pctVol)) %>%
  pivot_wider(names_from = toxVal, 
              values_from = toxPct) %>%
  rename("missing Tox value" = `FALSE`,
         "Tox value present" = `TRUE`)
```
```{r, warning = FALSE, message = FALSE}
knitr::kable(AdultContactLD50.summary, digits = 1)
```

# Analysis of Adult Contact LD50 RQs for Corn & Soybean

```{r, include = FALSE}
CornSoyAdultContact.dat <- AgroTrak.CornSoy.dat %>%
  left_join(AdultContactLD50) %>%
  mutate(Year = as.numeric(Year),
    lbs.acre = Volume.lbs / Base.Area.Treated,
    BeeREX.RQ = Volume.lbs * 2.7 / ObsRespMean,
    BeeREX.RQ.acre = lbs.acre * 2.7 / ObsRespMean) %>%
  group_by(Crop, Year, Type) %>%
  mutate(totalVol = sum(Volume.lbs, na.rm = TRUE),
         totalRQ = sum(BeeREX.RQ, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Volume.pctOfType = Volume.lbs / totalVol * 100,
         RQ.pctOfType = BeeREX.RQ / totalRQ * 100) %>%
  select(-totalVol, -totalRQ)
glimpse(CornSoyAdultContact.dat)
```

List of active ingredients that made up greater than 1% of a group's volume in any single year but have no adult dermal LD50 value:

```{r}
CornSoyAdultContact.dat %>%
  filter(is.na(RQ.pctOfType) & Volume.pctOfType > 1) %>%
  distinct(Type, ai) %>%
  arrange(Type)
```

```{r, include = FALSE}
CornSoyAdultContact.YearSums <- CornSoyAdultContact.dat %>%
  group_by(Crop, Year, Type) %>%
  summarize(Volume.lbs = sum(Volume.lbs, na.rm = TRUE),
            Volume.acre = mean(lbs.acre, na.rm = TRUE),
            RQ = sum(BeeREX.RQ, na.rm = TRUE),
            RQ.Acre = sum(BeeREX.RQ.acre, na.rm = TRUE))
glimpse(CornSoyAdultContact.YearSums)

plotA <- ggplot(CornSoyAdultContact.YearSums, 
       aes(x = Year, y = Volume.lbs)) +
  geom_point(aes(color = Type, shape = Type), alpha = .5) +
  stat_smooth(aes(color = Type), se = FALSE, span = .9) +
  facet_grid(. ~ Crop) +
  cowplot::theme_minimal_hgrid() +
  theme(legend.title = element_blank()) +
  ylab("Total Volume\n(lbs)")

plotB <- ggplot(CornSoyAdultContact.YearSums, 
       aes(x = Year, y = Volume.acre)) +
  geom_point(aes(color = Type, shape = Type), alpha = .5) +
  stat_smooth(aes(color = Type), se = FALSE, span = .9) +
  facet_grid(. ~ Crop) +
  cowplot::theme_minimal_hgrid() +
  theme(legend.title = element_blank()) +
  ylab("Volume per Treated\nAcre (lbs)")

plotC <- ggplot(CornSoyAdultContact.YearSums, 
       aes(x = Year, y = RQ)) +
  geom_point(aes(color = Type, shape = Type), alpha = .5) +
  stat_smooth(aes(color = Type), se = FALSE, span = .9) +
  facet_grid(. ~ Crop) +
  cowplot::theme_minimal_hgrid() +
  theme(legend.title = element_blank()) +
  ylab("Total Honey Bee RQ")

plotD <- ggplot(CornSoyAdultContact.YearSums, 
       aes(x = Year, y = RQ.Acre)) +
  geom_point(aes(color = Type, shape = Type), alpha = .5) +
  stat_smooth(aes(color = Type), se = FALSE, span = 1.2) +
  facet_grid(. ~ Crop) +
  cowplot::theme_minimal_hgrid() +
  theme(legend.title = element_blank()) +
  ylab("Total Honey Bee RQ\nper Treated Acre")

cowplot::plot_grid(plotA, plotB, plotC, plotD,
                   ncol = 1, 
                   align = "v") -> plot.4panel
ggsave("Plot_4Panel-CornSoy.png", plot.4panel,
       width = 7, height = 10, units = "in", dpi = 600)

plotC.sep <- plotC +
  facet_grid(Type ~ Crop, scales = "free_y") +
  theme(legend.position = "none") +
  ylim(c(0,NA))
plotD.sep <- plotD +
  facet_grid(Type ~ Crop, scales = "free_y") +
  theme(legend.position = "none") +
  ylim(c(0,NA))

cowplot::plot_grid(plotC.sep, plotD.sep, 
          nrow = 1,
          align = "h") -> plotFacets
ggsave("Plot_RQ-CornSoy.png", plotFacets,
       width = 10, height = 7, units = "in", dpi = 600)

```

# Figures

**Total pesticide volume applied.**

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 7, fig.height = 2.5}
plotA
```

---

**Pesticide volume applied per treated acre.**

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 7, fig.height = 2.5}
plotB
```

---

**Summed honey bee risk quotient values for all pesticides.**

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 7, fig.height = 2.5}
plotC
```

---

**Summed honey bee risk quotient values per treated acre.**

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 7, fig.height = 2.5}
plotD
```

---

**Same RQ plots, faceted & scaled to see fungicide & herbicide trends.**

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 5, fig.height = 5}
plotC.sep + geom_hline(yintercept = 0)
plotD.sep + geom_hline(yintercept = 0)
```

---

```{r, include = FALSE}
CornSoyAdultContact.post2005 <- CornSoyAdultContact.dat %>%
  filter(Year > 2005) %>%
  group_by(Crop, Type, ai) %>%
  summarize(VolumeContrib = round(mean(Volume.pctOfType, na.rm = TRUE), 1),
            RQContrib = round(mean(RQ.pctOfType, na.rm = TRUE),1)) %>%
  mutate(Diff.11 = RQContrib - VolumeContrib) %>%
  arrange(-Diff.11)
```

##

```{r plotAttempt1, echo = FALSE, warning = FALSE}
top11.lists <- CornSoyAdultContact.dat %>%
  group_by(Crop, Type, ai) %>%
    summarize(RQContrib = mean(RQ.pctOfType, na.rm = TRUE)) %>%
    slice_max(RQContrib, n=11)
cropType.tab <- expand_grid(Crop = c("Soybeans", "Corn"),
            Type = c("Insecticide", "Fungicide", "Herbicide"))

for(i in 1:nrow(cropType.tab)){
  assign(paste0(cropType.tab$Crop[[i]], cropType.tab$Type[[i]], ".top11"),
         top11.lists %>% 
           filter(Crop == cropType.tab$Crop[[i]] & 
                    Type == cropType.tab$Type[[i]]) %>%
           pull(ai))
}
top11.cols <- mget(ls(pattern = ".top11")) %>%
  bind_cols()

for(i in 1:nrow(cropType.tab)) {
  searchList.i <- paste0(cropType.tab[i,1], cropType.tab[i,2], ".top11")
  assign(paste0(cropType.tab$Crop[[i]], cropType.tab$Type[[i]], ".tmp"),
         CornSoyAdultContact.dat %>%
           filter(Crop == cropType.tab$Crop[[i]] & 
                    Type == cropType.tab$Type[[i]]) %>%
           mutate(ai.top = case_when(
             ai %in%  top11.cols[[searchList.i]] ~ ai,
             TRUE ~ "Other")))
  }

CornSoyAdultContact.dat2 <- mget(ls(pattern = ".tmp")) %>%
  bind_rows() %>%
  group_by(Year, Crop, Type, ai.top) %>%
  summarize(BeeREX.RQ = sum(BeeREX.RQ, na.rm = TRUE),
            BeeREX.RQ.acre = sum(BeeREX.RQ.acre, na.rm = TRUE),
            RQ.pctOfType = sum(RQ.pctOfType, na.rm = TRUE))
glimpse(CornSoyAdultContact.dat2)

for(i in 1:nrow(cropType.tab)){
  searchList.i <- paste0(cropType.tab[i,1], cropType.tab[i,2], ".top11")
  assign(paste0(cropType.tab$Crop[[i]], cropType.tab$Type[[i]], ".gg"),
ggplot(CornSoyAdultContact.dat2 %>% 
         filter(Crop == cropType.tab$Crop[[i]] & 
                Type == cropType.tab$Type[[i]]) %>%
         mutate(ai.top = factor(ai.top, ordered = TRUE,
                levels = c("Other", rev(top11.cols[[searchList.i]])))), 
       aes(x = Year, y = BeeREX.RQ/1000000, text = ai.top)) + 
  geom_area(aes(fill = ai.top)) +
  scale_fill_carto_d(name = "active ingredient", 
                     palette = "Safe", direction = -1) +
  ylab("BeeREX Acute RQ (millions)") +
  ggtitle(paste0(cropType.tab$Crop[[i]], ": ", cropType.tab$Type[[i]])))
}

ggplotly(SoybeansInsecticide.gg, tooltip = "text")
ggplotly(SoybeansHerbicide.gg, tooltip = "text")
ggplotly(SoybeansFungicide.gg, tooltip = "text")
ggplotly(CornInsecticide.gg, tooltip = "text")
ggplotly(CornHerbicide.gg, tooltip = "text")
ggplotly(CornFungicide.gg, tooltip = "text")

ggsave("Figure_6panelRQ.png", 
       cowplot::plot_grid(
         SoybeansInsecticide.gg, CornInsecticide.gg,
         SoybeansHerbicide.gg, CornHerbicide.gg, 
         SoybeansFungicide.gg, CornFungicide.gg,
         nrow = 3, align = "vh"), 
       height = 10, width = 12, units = "in", dpi = 600)
ggsave("Figure_CornRQ.png", 
       cowplot::plot_grid(
         CornInsecticide.gg,
         CornHerbicide.gg, 
         CornFungicide.gg,
         ncol = 1, align = "v"), 
       height = 11, width = 7, units = "in", dpi = 600)
ggsave("Figure_SoybeanRQ.png", 
       cowplot::plot_grid(
         SoybeansInsecticide.gg,
         SoybeansHerbicide.gg,
         SoybeansFungicide.gg,
         ncol = 1, align = "v"), 
       height = 11, width = 7, units = "in", dpi = 600)

```

### Soybean Insect Pest Targets:

**The "RQ Pest Index" needs some scrutiny...**

```{r, fig.width = 12, fig.height = 12, echo = FALSE, warning = FALSE, message = FALSE}
SoyRQs <- CornSoyAdultContact.dat %>%
  filter(Crop == "Soybeans" & Type == "Insecticide") %>%
  select(Year, Crop, ai, RQ.pctOfType) %>%
  mutate(RQ.pctOfType = round(RQ.pctOfType, 2))
#glimpse(SoyRQs)  

AgroTrak.SoyPest.dat <- read_excel("SoybeanTop11Insecticides_PestTargets.xlsx", 
                                   skip = 5) %>%
  select(Year, Crop,
         Active.Ingredient = "Active Ingredient",
         Pest = Pests,
         Volume.lbs = "AI volume\r\n(lb)",
         Base.Area.Treated = "Base Area Treated\r\n(acres)",
         Total.Area.Treated = "Total Area Treated\r\n(acres)") %>%
  mutate(ai = str_replace_all(Active.Ingredient, " \\(.\\)", ""),
         Year = as.numeric(Year)) %>%
  left_join(SoyRQs)
#glimpse(AgroTrak.SoyPest.dat)

soy.aiOrder <- AgroTrak.SoyPest.dat %>%
  group_by(Active.Ingredient) %>%
  summarize(Base.Area.Treated = mean(Base.Area.Treated)) %>%
  arrange(-Base.Area.Treated) %>%
  select(Active.Ingredient)
#soy.aiOrder  

Pest.ggdat <- AgroTrak.SoyPest.dat %>%
  group_by(Year, Crop, Active.Ingredient) %>%
  mutate(total.Volume = sum(Volume.lbs),
         total.BaseArea = sum(Base.Area.Treated)) %>%
  ungroup() %>% 
  group_by(Year, Crop, Active.Ingredient, Pest) %>%
  summarize(Pest.pctBaseArea = Base.Area.Treated / total.BaseArea * 100,
            Pest.pctVolume = Volume.lbs / total.Volume * 100,
            RQ.pctOfType = mean(RQ.pctOfType)) %>%
  ungroup() %>%
  mutate(BaseAreaRQ.wt = Pest.pctBaseArea * RQ.pctOfType,
         VolumeRQ.wt = Pest.pctVolume * RQ.pctOfType) %>%
  group_by(Pest) %>%
  summarize(BaseAreaRQ.wt = mean(BaseAreaRQ.wt),
            VolumeRQ.wt = mean(VolumeRQ.wt)) 

cowplot::plot_grid(
  ggplot(Pest.ggdat, aes(x = BaseAreaRQ.wt, y = reorder(Pest, BaseAreaRQ.wt))) +
    geom_point() +
    theme(legend.position = "none") +
    ylab(element_blank()) +
    xlab("Treated Area RQ Pest Index"),
  ggplot(Pest.ggdat, aes(x = VolumeRQ.wt, y = reorder(Pest, VolumeRQ.wt))) +
    geom_point() +
    theme(legend.position = "none") +
    ylab(element_blank()) +
    xlab("Pesticide Volume RQ Pest Index"),
  ncol = 2, align = "h")
ggsave("SoybeanPestTargets.png", width = 12, height = 11, units = "in", dpi = 600)
```

