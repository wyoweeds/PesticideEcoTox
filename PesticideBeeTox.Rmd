---
title: "Toxicity of pesticides to honey bee used in United States corn and soybean production, 1998 -- 2020"
author: "Andrew R. Kniss"
date: "updated `r Sys.Date()`"
output: html_document
---

---

```{r setup, include = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
library("tidyverse")
library("cowplot")
library("readxl")
library("openxlsx")
library("plotly")
library("rcartocolor")
library("tidytext")
library(knitr)
opts_knit$set(eval.after = "fig.cap")

### Load Kynnetec AgroTrak pesticide data (proprietary):
AgroTrak.Timing.dat <- read_excel(
  "DATA/US AgroTrak Chemical Use Timing.xlsx",
  skip = 5) %>%
  select(Year, Crop,
         Timing0 = `Application Timing`,
         Type = `Pesticide Type`,
         Active.Ingredient = `Active Ingredient`,
         Volume.lbs = `AI volume\r\n(lb)`,
         Base.Area.Treated = `Base Area Treated\r\n(acres)`,
         Total.Area.Treated = `Total Area Treated\r\n(acres)`) %>%
  mutate(ai = str_replace_all(Active.Ingredient, " \\(.\\)", ""),
         Timing = case_when(
           Timing0 %in% c("At Planting", "Before Crop Emergence",
                          "Last Fall", "Prior to Planting") ~ "PRE",
           Timing0 %in% c("Early Post (Herbicides)", "Late Post (Herbicides)",
                          "Postemergence (Non-Herbicides)",
                          "Foliar atTasseling (Fungicides)", 
                          "Foliar before Tasseling (Fungicides)") ~ "POST"),
         Timing = factor(Timing, ordered = "TRUE",
                            levels = c("PRE", "POST"))) %>%
  group_by(Year, Crop, Timing, Type, Active.Ingredient, ai) %>%
  summarize(Volume.lbs = round(sum(Volume.lbs)),
            Base.Area.Treated = round(sum(Base.Area.Treated)),
            Total.Area.Treated = round(sum(Total.Area.Treated))) %>%
    mutate(Type = factor(Type,
                         levels = c("Insecticide", "Herbicide", "Fungicide")))
glimpse(AgroTrak.Timing.dat)

## Get full pesticide list from AgroTrak:
AgroTrak.aiList <- AgroTrak.Timing.dat %>%
  select(ai) %>%
  distinct()

### load Farruggia et al. (2022) tox data:
farruggia.s1.all <- read_excel("DATA/journal.pone.0265962.s001.xlsx",
                          sheet = "Supporting Table S1", 
                          skip = 7, 
                          col_names = c("Pesticide", "PCCODE", 
                                        "Type", "Class", "MOA", 
                                        "AAC.LD50", LETTERS[1:7])) %>%
  select(Pesticide:AAC.LD50) %>%
  mutate(ineq = ifelse(str_detect(AAC.LD50, ">"), ">", NA),
         AAC.LD50 = as.numeric(str_remove(AAC.LD50, ">")),
         ai = str_to_upper(Pesticide)) %>%
  mutate(source = "Farruggia et al. 2022") %>%
  select(ai, ineq, AAC.LD50, source)
glimpse(farruggia.s1.all)

### Load concordance file:
srcTab <- read_csv("DATA/cclistInEcotox.csv")
glimpse(srcTab)

### Load honey bee toxicity values from Ecotox export
ecotox.dat0 <- 
  read_excel("DATA/ECOTOX-Terrestrial-Export_20211207.xlsx",
             sheet = "Terrestrial-Export") %>%
  rename(cas.number = "CAS Number", chemName = "Chemical Name") %>%
  filter(`Species Scientific Name` == "Apis mellifera") %>%
  select(source, cas.number, chemName,
         Species = `Species Scientific Name`, 
         Lifestage = `Organism Lifestage`,
         ExposureType = `Exposure Type`, 
         concType = `Conc 1 Type (Author)`,
         Effect, Endpoint, ineq = `Observed Response Mean Op`,
         ObsRespMean = `Observed Response Mean`,
         ToxUnit = `Observed Response Units`,
         ObservedDuration.d = `Observed Duration (Days)`)
glimpse(ecotox.dat0)

### Join with the concordance list:
ecotox.dat1 <- ecotox.dat0 %>%
  filter(Lifestage == "Adult" &
           Endpoint == "LD50" & 
           ExposureType == "Dermal") %>%
  right_join(srcTab) %>%
  select(-inEcoTox, -inManualAdd, -ModeOfAction)
glimpse(ecotox.dat1) 

## SELECTION LOGIC for exported Ecotox data
## For ais with multiple adult acute dermal LD50 values in Ecotox:
## 1) if there is only one exact estimate use it (exclude > values)
## 2) if there are multiple exact estimates, use the lowest value
## 3) if there are no exact estimates, use the lowest > value (questionable...)
ecotox.select1 <- ecotox.dat1 %>%
  group_by(ai) %>%
  mutate(n.est = sum(is.na(ineq))) %>%
  filter(case_when(
    n.est == 1 ~ is.na(ineq), ## (1)
    n.est > 1 ~ is.na(ineq) & ObsRespMean == min(ObsRespMean), ## (2)
    n.est == 0 ~ ObsRespMean == min(ObsRespMean) ## (3)
  )) %>%
  select(ai, ineq, AAC.LD50 = ObsRespMean, source)
glimpse(ecotox.select1)

ecotox.dat2 <- left_join(ecotox.select1 %>% select(ai, 
                                                   eco.ineq = ineq,
                                                   eco.LD50 = AAC.LD50), 
                         farruggia.s1.all %>% select(ai,
                                                     far.ineq = ineq,
                                                     far.LD50 = AAC.LD50)) %>%
    mutate(same.LD50 = eco.LD50 == far.LD50,
           lower.LD50 = case_when(
           eco.LD50 - far.LD50 < 0 ~ "Ecotox",
           eco.LD50 - far.LD50 > 0 ~ "Farruggia",
           same.LD50 == TRUE ~ "Same")) %>%
    arrange(lower.LD50, eco.ineq)
glimpse(ecotox.dat2)
which.farruggia <- ecotox.dat2 %>%
  filter(lower.LD50 == "Farruggia") %>%
  select(ai)
which.farruggia

## Load manually searched tox values from PRA/ERA documents:
missingSearch.dat <- read_excel("DATA/MissingToxDataSearch.xlsx",
                                sheet = "MissingToxDataSearch",
                                range = cell_cols("A:F")) %>%
  select(ai, ineq, AAC.LD50, source)
glimpse(missingSearch.dat)

finalTox.dat <- bind_rows(
  ecotox.select1 %>% filter(!ai %in% which.farruggia$ai & 
                              !is.na(AAC.LD50)),
  farruggia.s1.all %>% filter(ai %in% which.farruggia$ai),
  missingSearch.dat %>% filter(!is.na(AAC.LD50))
) %>%
  group_by(ai) %>%
  distinct() %>%
  mutate(AAC.LD50 = ifelse(ai == "DICAMBA", 90.65, AAC.LD50),
         ineq = ifelse(ai == "DICAMBA", ">", ineq),
         source = ifelse(ai == "DICAMBA", "Ecotox Export", source)) %>%
  bind_rows(data.frame(ai = "CYANAZINE", 
                       ineq = ">", AAC.LD50 = 193.38,
                       source = "EPA communication"))
glimpse(finalTox.dat)
write_csv(finalTox.dat, "finalToxData.csv")

## USDA planted acres:
plantedAcres.dat <- read_csv("DATA/USDA-PlantedAcresProduction_1990-2022.csv") %>%
  select(Year, State, Commodity, Data.Item = `Data Item`, Value) %>%
  mutate(Data.Item = 
           str_remove(Data.Item, 
                      c("CORN - |CORN, GRAIN - |SOYBEANS - "))) %>%
  pivot_wider(id_cols = c(Year, State, Commodity),
              values_from = Value,
              names_from = Data.Item) %>%
  rename(Acres = `ACRES PLANTED`,
         productionBu = `PRODUCTION, MEASURED IN BU`,
         productionUSD = `PRODUCTION, MEASURED IN $`) %>%
  mutate(Crop = str_to_title(Commodity),
         PlantedHectares = Acres / 2.47,
         ProductionTonnes = case_when(
           Crop == "Corn" ~ round(productionBu * 56 * 0.45359 /1000),
           Crop == "Soybeans" ~ round(productionBu * 60 * 0.45359 /1000)),
         Yield.tha = round(ProductionTonnes / PlantedHectares, 2),
         ProductionBUSD = case_when(
           Crop == "Corn" ~ round(productionUSD / 10^9, 1),
           Crop == "Soybeans" ~ round(productionUSD / 10^9, 1))) %>%
  select(Year, Crop, PlantedHectares, ProductionTonnes, ProductionBUSD, Yield.tha)
glimpse(plantedAcres.dat)

## Merge with usage data
AgroTrak.ecotox <-
  AgroTrak.Timing.dat %>%
  left_join(finalTox.dat) %>%
  mutate(Year = as.numeric(Year),
         Volume.kg = round(Volume.lbs * 0.454),
         BaseArea.ha = round(Base.Area.Treated / 2.47),
         TotalArea.ha = round(Total.Area.Treated / 2.47),
         Rate.kgha = Volume.kg / BaseArea.ha) %>%
  left_join(plantedAcres.dat) %>%
  mutate(BeeRex.EEC = (Volume.kg / BaseArea.ha) * 2.4 / AAC.LD50,
         ToxIndex.vol = Volume.kg / AAC.LD50,
         ToxIndex.rate = Rate.kgha / AAC.LD50,
         ToxIndex.area = (Volume.kg / AAC.LD50) / PlantedHectares)
glimpse(AgroTrak.ecotox)
```

# Data sources:

## Pesticide usage data

Proprietary pesticide use data were obtained from the FarmTrak product maintained by [Kynetec](https://www.kynetec.com/). Data included volume applied, treated acreage, and timing of pesticide applications for corn and soybean from 1998 through 2020. Application timings from the original data were condensed into either before crop emergence (PRE) or after crop emergence (POST). 

## Honey bee toxicity data

Adult acute contact $LD_{50}$ values for honey bee (*Apis mellifera*) were obtained from the following sources:

* The U.S. EPA [ECOTOX](https://cfpub.epa.gov/ecotox/) database.
* Supporting Table S1 from [Farruggia et al (2022)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0265962)
* Manually searching pesticide registration documents and conversations with EPA EFED personnel. 

The ECOTOX database was the preferred source for all pesticide toxicity data. For each active ingredient (ai) in the Kynetec data, adult acute contact $LD_{50}$ were downloaded from ECOTOX. For many active ingredients, ECOTOX reports multiple toxicity endpoints, some are exact estimates (e.g. $LD_{50}$ = 13 ug/bee). Some estimates are listed as inequalities, where the original study was unable to quantify an exact endpoint (e.g. $LD_{50}$ > 100 ug/bee). For active ingredients with multiple adult acute contact toxicity values reported, we used the following selection criteria to select a single toxicity value for each ai:

1) if there was only one *exact* estimate and one or more inequality estimates the exact estimate was selected.
2) if there were multiple exact estimates, the lowest (most toxic) value was selected.
3) if there were no exact estimates, the lowest (most toxic) inequality was selected. 

After this selection criteria was applied to the ECOTOX data, the toxicity values were compared with those published by Farruggia et al. (2022). In nearly all cases, the ECOTOX values were the same as those published by Farruggia et al. For 6 pesticides, the values reported by Farruggia et al. were lower (*i.e.* more toxic) than those selected from ECOTOX; for five of those six pesticides, the Farruggia et al. values were used to ensure we used the most conservative toxicity estimates available. One estimate from Farrugia et al (2022) was determined to be an error; dicamba adult acute contact toxicity was listed correctly in ECOTOX and so that value was used. Finally, for any ai in the Kynetec data that did not have toxicity values in ECOTOX or Farruggia et al. (2022), pesticide registration documents were searched manually to obtain honey bee adult acute contact toxicity values. 

```{r, include = FALSE, warning = FALSE, message = FALSE}
missDat <- AgroTrak.ecotox %>%
  group_by(ai) %>%
  summarize(totalVol = signif(sum(Volume.kg), 3),
            totalBase = signif(sum(Base.Area.Treated), 3),
            AAC.LD50 = unique(AAC.LD50)) %>%
  filter(is.na(AAC.LD50) & totalVol > 1000) %>%
  arrange(desc(totalBase)) %>%
  select(ai, AAC.LD50, totalVol, totalBase) %>%
  data.frame()
goodDat <- AgroTrak.ecotox %>%
  group_by(ai) %>%
  summarize(AAC.LD50 = unique(AAC.LD50)) %>%
  filter(!is.na(AAC.LD50)) %>%
  select(ai)
```

In total, there were `r length(missDat$ai) + length(goodDat$ai)` unique pesticides in the Kynetec database applied to either corn or soybean during 1998 to 2020. Of those, we were unable to find a reliable toxicity estimate for `r length(missDat$ai)` pesticides (Table 1). Two of those pesticides (tebupirimphos and ethalfluralin) were widely used during the study period, with total application volume of nearly 3 million kg and over 1 million kg, respectively. 

```{r, echo = FALSE, warning = FALSE, message = FALSE}
knitr::kable(missDat %>% select(-AAC.LD50),
             col.names = c("Active ingredient", 
                           "Total volume (kg)", 
                           "Total base acres treated"),
             caption = "**Table 1. Active ingredients for which more than 1,000 kg were applied during the period 1998 -- 2020 but do not have a reliable honey bee adult acute contact $LD_{50}$.**")
```

# Honey bee Toxicity Indices

```{r, include = FALSE}
ToxIndex.summary.yr <- AgroTrak.ecotox %>%
  group_by(Year, Crop, Timing, Type) %>%
  summarize(ToxIndex.vol = sum(ToxIndex.vol, na.rm = TRUE),
            ToxIndex.rate = sum(ToxIndex.rate, na.rm = TRUE),
            ToxIndex.area = sum(ToxIndex.area, na.rm = TRUE),
            Yield.tha = mean(Yield.tha, na.rm = TRUE),
            Value.BUSD = mean(ProductionBUSD, na.rm = TRUE)) %>%
  mutate(EcoEff.Y = Yield.tha / ToxIndex.area,
         EcoEff.V = Value.BUSD / ToxIndex.area)
ToxIndex.summary <- AgroTrak.ecotox %>%
  group_by(Crop, Timing, Type) %>%
  summarize(ToxIndex.vol = sum(ToxIndex.vol, na.rm = TRUE),
            ToxIndex.rate = sum(ToxIndex.rate, na.rm = TRUE),
            ToxIndex.area = sum(ToxIndex.area, na.rm = TRUE),
            Yield.tha = mean(Yield.tha, na.rm = TRUE),
            Value.BUSD = mean(ProductionBUSD, na.rm = TRUE)) %>%
  mutate(EcoEff.Y = Yield.tha / ToxIndex.area,
         EcoEff.V = Value.BUSD / ToxIndex.area) %>%
  group_by(Crop) %>% 
  mutate(cropToxIndex.vol = sum(ToxIndex.vol),
         cropToxIndex.rate = sum(ToxIndex.rate),
         cropToxIndex.area = sum(ToxIndex.area),
         cropEcoEff.Y = sum(EcoEff.Y),
         cropEcoEff.V = sum(EcoEff.V),
         cropToxIndex.volPct = signif(ToxIndex.vol / 
                                         cropToxIndex.vol*100, 2),
         cropToxIndex.ratePct = signif(ToxIndex.rate / 
                                         cropToxIndex.rate*100, 2),
         cropToxIndex.areaPct = signif(ToxIndex.area / 
                                         cropToxIndex.area*100, 2),
         cropEcoEff.Y.Pct = signif(EcoEff.Y / cropEcoEff.Y*100, 2),
         cropEcoEff.V.Pct = signif(EcoEff.V / cropEcoEff.V*100, 2))

ToxIndex.cropTotals <- ToxIndex.summary %>% 
  group_by(Crop) %>% 
  summarize(cropToxIndex.vol = unique(cropToxIndex.vol),
            cropToxIndex.rate = unique(cropToxIndex.rate),
            cropToxIndex.area = unique(cropToxIndex.area),
            cropEcoEff.Y = unique(cropEcoEff.Y),
            cropEcoEff.V = unique(cropEcoEff.V))
ToxIndex.cropTotals

cropType.summary <- ToxIndex.summary %>% 
  group_by(Crop, Type) %>%
  summarize(cropToxIndex.volPct = sum(cropToxIndex.volPct),
            cropToxIndex.ratePct = sum(cropToxIndex.ratePct),
            cropToxIndex.areaPct = sum(cropToxIndex.areaPct))
```

```{r, echo = FALSE}
knitr::kable(cropType.summary)
```

Pesticide use data were separated into pesticides applied before crop emergence (PRE) and pesticides applied after crop emergence (POST). For each ai applied to each crop in each year, an application rate-based toxicity index $TI_{rate}$ was calculated by dividing $P_{vol}$ by the area treated with the pesticide in hectares ($A_{trt}$) to get the average application rate, then dividing that application rate by the adult acute contact $LD_{50}$.  

$$TI_{rate} = \sum_{i=1}^{N_{CYT}} (\frac{P_{vol} / A_{trt}}{LD_{50}})$$

An area-adjusted toxicity index ($TI_{area}$) was calculated by dividing $P_{vol}$ by planted area ($A_{plant}$) for each crop to account for year-to-year changes in hectares planted to corn and soybeans, then divided by the adult acute contact $LD_{50}$. $TI_{area}$ can be interpreted as the number of honey bee acute $LD_{50}$ values applied per hectare.

$$TI_{area} = \sum_{i=1}^{N_{CYT}} (\frac{P_{vol} / A_{plant}}{LD_{50}})$$

**[note: should we bother with the $TI_{rate}$, or just focus on $TI_{area}$? I'm leaning towards only presenting area-adjusted since it is the most relevant.]**

Eco-efficiency ($E$) was calculated for each year and application timing by dividing crop yield (ton/ha) by $TI_{rate}$. $E$ can be interpreted as the tonnes of crop yield produced per honey bee $LD_{50}$ applied. Higher values of $E$ suggest greater eco-efficiency.

$$E = \frac{Y}{TI_{area}}$$

---

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 3, fig.cap = "**Figure 1. Summed honey bee toxicity index applied to corn or soybean during the period 1998 through 2020 by pesticide type and application timing.**"}
tisum.rate.gg <- ggplot(ToxIndex.summary, 
       aes(x = ToxIndex.rate, y = Type)) +
  facet_grid(Crop ~ Timing) + 
  geom_bar(stat = "identity",
           aes(fill = Crop)) +
  ylab(element_blank()) +
  xlab("Rate-adjusted honey bee acute toxicity index") +
  theme_minimal_grid() +
  theme(legend.position = "none")
tisum.area.gg <- ggplot(ToxIndex.summary, 
       aes(x = ToxIndex.area, y = Type)) +
  facet_grid(Crop ~ Timing) + 
  geom_bar(stat = "identity",
           aes(fill = Crop)) +
  ylab(element_blank()) +
  xlab("Area-adjusted honey bee acute toxicity index") +
  theme_minimal_grid() +
  theme(legend.position = "none",
        plot.title.position = "plot") #+
  #ggtitle("Area-adjusted Toxicity Index, 1998 - 2020")

ecoeffYsum.gg <- ggplot(ToxIndex.summary, 
       aes(x = EcoEff.Y, y = Type)) +
  facet_grid(Crop ~ Timing) + 
  geom_bar(stat = "identity",
           aes(fill = Crop)) +
  ylab(element_blank()) +
  xlab("Honey bee acute toxicity eco-efficiency") +
  theme_minimal_grid() +
  theme(legend.position = "none")
ecoeffVsum.gg <- ggplot(ToxIndex.summary, 
       aes(x = EcoEff.V, y = Type)) +
  facet_grid(Crop ~ Timing) + 
  geom_bar(stat = "identity",
           aes(fill = Crop)) +
  ylab(element_blank()) +
  xlab("Honey bee acute toxicity eco-efficiency") +
  theme_minimal_grid() +
  theme(legend.position = "none")

tisum.area.gg
# plot_grid(tisum.rate.gg, tisum.area.gg, ecoeffsum.gg,
#           ncol = 1,
#           labels = c("Rate-adjusted TI", "Area-adjusted TI", "Eco-efficiency"),
#           hjust = -0.1)
```

---

```{r, include = FALSE}
### These bullet points from below moved here to avoid printing. Can move them back if desired.
#* The summed honey bee $TI_{rate}$ over all years was `r round(ToxIndex.cropTotals$cropToxIndex.rate[1]/ToxIndex.cropTotals$cropToxIndex.rate[2], 1)`-times greater in corn compared to soybean.

```

* The summed honey be $TI_{area}$ over all years was `r round(ToxIndex.cropTotals$cropToxIndex.area[1]/ToxIndex.cropTotals$cropToxIndex.area[2], 1)`-times greater in corn compared to soybean.
* `r cornTot <- ToxIndex.summary %>% filter(Crop == "Corn" & Timing == "PRE") %>% summarize(a = sum(cropToxIndex.areaPct))
round(cornTot[[2]])`% of the summed $TI_{area}$ applied to corn was applied *before* crop emergence, when relative risk to honey bees and many other pollinator species is expected to be lower. 
* `r soyTot <- ToxIndex.summary %>% filter(Crop == "Soybeans" & Timing == "POST") %>% summarize(a = sum(cropToxIndex.areaPct))
round(soyTot[[2]])`% of the summed $TI_{area}$ applied to soybean was applied *after* crop emergence, when relative risk to honey bees and many other pollinator species is expected to be higher.
* In corn, insecticides were responsible for `r corn.i <- cropType.summary %>% filter(Crop == "Corn" & Type == "Insecticide")
corn.i$cropToxIndex.areaPct`% of $TI_{area}$, compared to `r corn.h <- cropType.summary %>% filter(Crop == "Corn" & Type == "Herbicide")
signif(corn.h$cropToxIndex.areaPct,2)`% for herbicides, and `r corn.f <- cropType.summary %>% filter(Crop == "Corn" & Type == "Fungicide")
signif(corn.f$cropToxIndex.areaPct,2)`% for fungicides.
* In soybean, insecticides were responsible for `r soy.i <- cropType.summary %>% filter(Crop == "Soybeans" & Type == "Insecticide")
signif(soy.i$cropToxIndex.areaPct,2)`% of the summed $TI_{area}$, compared to `r soy.h <- cropType.summary %>% filter(Crop == "Soybeans" & Type == "Herbicide")
signif(soy.h$cropToxIndex.areaPct,2)`% for herbicides, and `r soy.f <- cropType.summary %>% filter(Crop == "Soybeans" & Type == "Fungicide")
signif(soy.f$cropToxIndex.areaPct,2)`% for fungicides.

---


```{r, include = FALSE, warning = FALSE, message = FALSE}
options(scipen = 10)
knitr::kable(ToxIndex.summary %>% 
               pivot_wider(id_cols = c(Type, Timing),
                           names_from = Crop,
                           values_from = cropToxIndex.areaPct) %>%
               arrange(Timing, Type),
             caption = "**Table 2. Percentage of the total honey bee risk quotient in corn and soybean by pesticide type and application timing.**")
```





```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 7, fig.height = 5, fig.cap = "**Figure 2. Honey bee adult acute contact toxicity index for insecticides applied to corn or soybean before (PRE) or after (POST) crop emergence.**"}
ggplot(data = ToxIndex.summary.yr %>%
         filter(Type == "Insecticide"),
       aes(y = ToxIndex.area, x = Year)) +
  facet_grid(Crop ~ Timing, scales = "free_y") +
  geom_point() + 
  stat_smooth(se = FALSE, span = 0.9) +
  ylab("Honeybee acute toxicity index") +
  theme_gray(base_size = 18) +
  scale_y_continuous(limits = c(0, NA)) 
```

* Over time, insecticide use in corn has shifted from primarily PRE applications to a mix of PRE and POST applications.
* In soybeans, insecticide applications have been mostly applied POST, and the honey bee acute toxicity index has increased 10-fold since the early 2000s.

**Area-adjusted acute toxicity index values for insecticides applied before (PRE) and after (POST) crop emergence for the periods 2000 to 2005, and from 2015 to 2020.**

```{r, echo = FALSE, message = FALSE, warning = FALSE}
ToxIndex.summary.early <- AgroTrak.ecotox %>%
  filter(Year > 1999 & Year < 2006) %>%
  group_by(Crop, Timing, Type) %>%
  summarize(ToxIndex.area = sum(ToxIndex.area, na.rm = TRUE)) %>%
  ungroup() %>% group_by(Crop) %>% 
  mutate(cropToxIndex.area = sum(ToxIndex.area),
         Period = "2000 - 2005")
ToxIndex.summary.late <- AgroTrak.ecotox %>%
  filter(Year > 2014) %>%
  group_by(Crop, Timing, Type) %>%
  summarize(ToxIndex.area = sum(ToxIndex.area, na.rm = TRUE)) %>%
  ungroup() %>% group_by(Crop) %>% 
  mutate(cropToxIndex.area = sum(ToxIndex.area),
         Period = "2015 - 2020")
ToxIndex.evl <- bind_rows(ToxIndex.summary.early, ToxIndex.summary.late)
knitr::kable(ToxIndex.evl %>% 
               filter(Type == "Insecticide") %>%
               mutate(ToxIndex.area = signif(ToxIndex.area, 2)) %>%
               select(Crop, Period, Timing, Type, ToxIndex.area) %>%
               arrange(Crop, Type, Timing, Period) %>%
               pivot_wider(id_cols = c(Crop, Timing, Type),
                           names_from = Period,
                           values_from = ToxIndex.area))
```


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 9, fig.cap = paste0("**Figure 4. Contribution of insecticide active ingredients to honey bee adult acute contact toxicity index applied to corn or soybean. 'All Other Insecticides' category includes ", 100-cornPre.top7prop, "% of the total corn toxicity index applied PRE, ", 100-corn.top7prop, "% of the total corn toxicity index applied POST, and ", 100-soy.top7prop, "% of the total soybean toxicity index. **")}

cornPre.90list <- AgroTrak.ecotox %>%
  filter(Type == "Insecticide" &
           Timing == "PRE" &
           Crop == "Corn") %>%
  group_by(ai) %>%
  summarize(ToxIndex.areaSum = sum(ToxIndex.area, na.rm = TRUE)) %>%
  arrange(-ToxIndex.areaSum) %>%
  mutate(total = sum(ToxIndex.areaSum),
         ToxIndex.prop = ToxIndex.areaSum / total,
         Tox.cumsum = cumsum(ToxIndex.prop)) %>%
  slice_max(ToxIndex.prop, n = 7)
cornPre.top7prop <- round(max(cornPre.90list$Tox.cumsum), 2) * 100

cornPost.90list <- AgroTrak.ecotox %>%
  filter(Type == "Insecticide" &
           Timing == "POST" &
           Crop == "Corn") %>%
  group_by(ai) %>%
  summarize(ToxIndex.areaSum = sum(ToxIndex.area, na.rm = TRUE)) %>%
  arrange(-ToxIndex.areaSum) %>%
  mutate(total = sum(ToxIndex.areaSum),
         ToxIndex.prop = ToxIndex.areaSum / total,
         Tox.cumsum = cumsum(ToxIndex.prop)) %>%
  slice_max(ToxIndex.prop, n = 7)
corn.top7prop <- round(max(cornPost.90list$Tox.cumsum), 2) * 100

soyPost.90list <- AgroTrak.ecotox %>%
  filter(Type == "Insecticide" &
           Timing == "POST" &
           Crop == "Soybeans") %>%
  group_by(ai) %>%
  summarize(ToxIndex.areaSum = sum(ToxIndex.area, na.rm = TRUE)) %>%
  arrange(-ToxIndex.areaSum) %>%
  mutate(total = sum(ToxIndex.areaSum),
         ToxIndex.prop = ToxIndex.areaSum / total,
         Tox.cumsum = cumsum(ToxIndex.prop)) %>%
  slice_max(ToxIndex.prop, n = 7)
soy.top7prop <- round(max(soyPost.90list$Tox.cumsum), 2) * 100

cbPalette.cornPre <- c("#D55E00", "#E69F00", "#999999", "#F0E442",
                         "#56B4E9", "#009E73",  "#0072B2", "#CC79A7")
cbPalette.corn <- c("#999999", "#E69F00", "#56B4E9", "#D55E00", 
                    "#009E73", "#F0E442", "#0072B2", "#CC79A7")
cbPalette.soy <- c("#999999", "#E69F00", "#009E73", "#56B4E9", 
                   "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
aiplot.ylab <- "Honey bee acute \ntoxicity index"

cornPre.aigg <- AgroTrak.ecotox %>%
  filter(Type == "Insecticide" &
           Timing == "PRE" &
           Crop == "Corn") %>%
  mutate(aiplot = case_when(
    ai %in% cornPre.90list$ai ~ ai,
    TRUE ~ "ALL OTHER INSECTICIDES"),
    aiplot = factor(aiplot, levels = c(cornPre.90list$ai,
                                       "ALL OTHER INSECTICIDES"))) %>%
  group_by(Year, aiplot) %>%
  summarize(ToxIndex.area = sum(ToxIndex.area, na.rm = TRUE)) %>%
  ungroup() %>%
  complete(aiplot, Year, fill = list(ToxIndex.area = 0)) %>%
  ggplot(aes(x = Year, y = ToxIndex.area)) +
  geom_area(aes(fill = aiplot)) +
  scale_fill_manual(values = cbPalette.cornPre) +
  ggtitle("Corn Insecticides Applied PRE") +
  xlim(c(1998, 2020)) +
  ylab(aiplot.ylab) + xlab(element_blank()) +
  theme_minimal_grid() +
  theme(legend.title = element_blank())

corn.aigg <- AgroTrak.ecotox %>%
  filter(Type == "Insecticide" &
           Timing == "POST" &
           Crop == "Corn") %>%
  mutate(aiplot = case_when(
    ai %in% cornPost.90list$ai ~ ai,
    TRUE ~ "ALL OTHER INSECTICIDES"),
    aiplot = factor(aiplot, levels = c(cornPost.90list$ai,
                                       "ALL OTHER INSECTICIDES"))) %>%
  group_by(Year, aiplot) %>%
  summarize(ToxIndex.area = sum(ToxIndex.area, na.rm = TRUE)) %>%
  ungroup() %>%
  complete(aiplot, Year, fill = list(ToxIndex.area = 0)) %>%
  ggplot(aes(x = Year, y = ToxIndex.area)) +
  geom_area(aes(fill = aiplot)) +
  scale_fill_manual(values = cbPalette.corn) +
  ggtitle("Corn Insecticides Applied POST") +
  xlim(c(1998, 2020)) +
  ylab(aiplot.ylab) + xlab(element_blank()) +
  theme_minimal_grid() +
  theme(legend.title = element_blank())
  
soy.aigg <- AgroTrak.ecotox %>%
  filter(Type == "Insecticide" &
           Timing == "POST" &
           Crop == "Soybeans") %>%
  mutate(aiplot = case_when(
    ai %in% c("BIFENTHRIN", "CHLORPYRIFOS", "CYHALOTHRIN-LAMBDA",
              "DELTAMETHRIN", "THIAMETHOXAM", "CYFLUTHRIN", "ACEPHATE") ~ ai,
    TRUE ~ "ALL OTHER INSECTICIDES"),
    aiplot = factor(aiplot, 
                    levels = c("BIFENTHRIN", "CHLORPYRIFOS", 
                               "CYHALOTHRIN-LAMBDA", "DELTAMETHRIN", 
                               "THIAMETHOXAM", "CYFLUTHRIN", "ACEPHATE",
                               "ALL OTHER INSECTICIDES"))) %>%
  group_by(Year, aiplot) %>%
  summarize(ToxIndex.area = sum(ToxIndex.area, na.rm = TRUE)) %>%
  ungroup() %>%
  complete(aiplot, Year, fill = list(ToxIndex.area = 0)) %>%
  ggplot(aes(x = Year, y = ToxIndex.area)) +
  geom_area(aes(fill = aiplot)) +
  scale_fill_manual(values = cbPalette.soy) +
  ggtitle("Soybean Insecticides Applied POST") +
  xlim(c(1998, 2020)) +
  ylab(aiplot.ylab) + xlab(element_blank()) +
  theme_minimal_grid() +
  theme(legend.title = element_blank())

#plot_grid(corn.aigg, soy.aigg,
#          nrow = 2, align = "v")
plot_grid(cornPre.aigg, corn.aigg, soy.aigg,
          ncol = 1, align = "v",
          labels = LETTERS)

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 9, fig.cap = "**Figure 5. Honeybee eco-efficiency index for pesticides applied to corn or soybean *after* crop emergence.**"}
plot_grid(
  ToxIndex.summary.yr %>% 
    filter(Crop == "Corn" & Timing == "POST" & Type != "Fungicide") %>%
    ggplot(aes(y = EcoEff.Y, x = Year)) +
    facet_wrap(~ Type, scales = "free_y",
               ncol = 1) +
    geom_point() + 
    stat_smooth(se = FALSE, span = 0.9) + 
    ylab("Yield Eco-Efficiency") +
    theme_gray(base_size = 18) +
    scale_y_continuous(limits = c(1, NA)) + #, expand = c(0, 0)) +
    ggtitle("Corn POST"),
  ToxIndex.summary.yr %>% 
  filter(Crop == "Soybeans" & Timing == "POST" & Type != "Fungicide") %>%
  ggplot(aes(y = EcoEff.Y, x = Year)) +
  facet_wrap(~ Type, scales = "free_y",
             ncol = 1) +
  geom_point() + 
  stat_smooth(se = FALSE, span = 0.9) + 
  ylab("Yield Eco-Efficiency") +
  theme_gray(base_size = 18) +
  scale_y_continuous(limits = c(1, NA)) + #, expand = c(0, 0)) +
  ggtitle("Soybeans POST"),
  ToxIndex.summary.yr %>% 
    filter(Crop == "Corn" & Timing == "POST" & Type != "Fungicide") %>%
    ggplot(aes(y = EcoEff.V, x = Year)) +
    facet_wrap(~ Type, scales = "free_y",
               ncol = 1) +
    geom_point() + 
    stat_smooth(se = FALSE, span = 0.9) + 
    ylab("Value Eco-Efficiency") +
    theme_gray(base_size = 18) +
    scale_y_continuous(limits = c(1, NA)) + #, expand = c(0, 0)) +
    ggtitle("Corn POST"),
  ToxIndex.summary.yr %>% 
  filter(Crop == "Soybeans" & Timing == "POST" & Type != "Fungicide") %>%
  ggplot(aes(y = EcoEff.V, x = Year)) +
  facet_wrap(~ Type, scales = "free_y",
             ncol = 1) +
  geom_point() + 
  stat_smooth(se = FALSE, span = 0.9) + 
  ylab("Value Eco-Efficiency") +
  theme_gray(base_size = 18) +
  scale_y_continuous(limits = c(1, NA)) + #, expand = c(0, 0)) +
  ggtitle("Soybeans POST"))
```


# Pest Index

```{r, include = FALSE}
## Currently only includes insects
pestList <- read_excel("DATA/PestLists.xlsx",
                       sheet = "PestList") %>%
  select(Crop, Pest, TaxonGroup, Genus)

AgroTrak.PestTiming.dat <- read_excel(
  "DATA/US AgroTrak Chemical Use Timing and Pests.xlsx",
  skip = 5) %>%
  select(Year, Crop,
         Timing0 = `Application Timing`,
         Type = `Pesticide Type`,
         Active.Ingredient = `Active Ingredient`,
         Pest = Pests,
         Volume.lbs = `AI volume\r\n(lb)`,
         Base.Area.Treated = `Base Area Treated\r\n(acres)`,
         Total.Area.Treated = `Total Area Treated\r\n(acres)`) %>%
  mutate(Year = as.numeric(Year),
         ai = str_replace_all(Active.Ingredient, " \\(.\\)", ""),
         Timing = case_when(
           Timing0 %in% c("At Planting", "Before Crop Emergence",
                          "Last Fall", "Prior to Planting") ~ "PRE",
           Timing0 %in% c("Early Post (Herbicides)", "Late Post (Herbicides)",
                          "Postemergence (Non-Herbicides)",
                          "Foliar atTasseling (Fungicides)", 
                          "Foliar before Tasseling (Fungicides)") ~ "POST"),
         Volume.kg = Volume.lbs * 454,
         Treated.ha = Base.Area.Treated / 2.47,
         AppRate.kgha = Volume.kg / Treated.ha) %>%
  left_join(pestList)
glimpse(AgroTrak.PestTiming.dat)

groupToxIndex <- AgroTrak.ecotox %>%
  group_by(Year, Crop, Timing) %>%
  mutate(ToxIndex.groupSum = sum(ToxIndex.area, na.rm = TRUE),
         ToxIndex.groupProp = ToxIndex.area / ToxIndex.groupSum) %>%
  select(Year, Crop, Timing, ai, 
         ToxIndex.groupProp)
glimpse(groupToxIndex)

AgroTrak.PestToxIndex <- AgroTrak.PestTiming.dat %>%
  left_join(groupToxIndex) %>% 
  select(-Timing0) %>%
  group_by(Year, Crop, Timing, ai) %>%
  mutate(ai.pestVol = Volume.kg / sum(Volume.kg)) %>%
  select(Year, Crop, Type, ai, Timing, Pest, TaxonGroup, Genus,
         ToxIndex.groupProp, ai.pestVol) %>%
  ungroup() %>%
  mutate(pestToxIndex = ToxIndex.groupProp * ai.pestVol)
glimpse(AgroTrak.PestToxIndex)
```

A pesticide target toxicity index was calculated using the following formula
For each active ingredient (applied in each year, crop, and timing), the volume applied targeting a particular pest was divided by the total volume of the active ingredient applied. This proportion was then multiplied by the proportion that active ingredient contributed to the area toxicity index $TI_{area}$.

$$TI_{pest} = (P_{pest} / P_{total}) * (TI_{area.ai} / TI_{area.group})$$
[this equation needs to be converted to sigma notation to be accurate....]

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 6, fig.cap = "**Figure 8. Contribution of insect pests to the honey bee adult acute contact toxicity index; corn pesticides applied *after* crop emergence, 1998-2020.**"}
AgroTrak.PestToxIndex %>%
  filter(Type == "Insecticide" & 
           Timing == "POST" &
           Crop == "Corn" &!is.na(TaxonGroup)) %>%
  group_by(Crop, Year, TaxonGroup) %>%
  summarize(pestToxIndex.sum = sum(pestToxIndex, na.rm = TRUE)) %>%
  group_by(Crop, TaxonGroup) %>%
  mutate(taxonKeep = length(!is.na(pestToxIndex.sum)) > 4) %>%
  filter(taxonKeep == TRUE) %>%
  ggplot(aes(x = Year, y = pestToxIndex.sum)) +
  geom_point() + stat_smooth(method = "lm", se = FALSE) +
  facet_wrap(~ TaxonGroup) +
  ggtitle("Corn POST Insecticide Targets") +
  ylab("Total Pest Toxicity Index")
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 6, fig.cap = "**Figure 9. Contribution of insect pests to the honey bee adult acute contact toxicity index; soybean pesticides applied *after* crop emergence, 1998-2020.**"}
AgroTrak.PestToxIndex %>%
  filter(Type == "Insecticide" & 
           Timing == "POST" &
           Crop == "Soybeans" &!is.na(TaxonGroup)) %>%
  group_by(Crop, Year, TaxonGroup) %>%
  summarize(pestToxIndex.sum = sum(pestToxIndex, na.rm = TRUE)) %>%
  group_by(Crop, TaxonGroup) %>%
  mutate(taxonKeep = length(!is.na(pestToxIndex.sum)) > 4) %>%
  filter(taxonKeep == TRUE) %>%
  ggplot(aes(x = Year, y = pestToxIndex.sum)) +
  geom_point() + stat_smooth(method = "lm", se = FALSE) +
  facet_wrap(~ TaxonGroup) +
  ggtitle("Soybean POST Insecticide Targets") +
  ylab("Total Pest Toxicity Index")
```

