---
title: "Toxicity of pesticides to honey bee used in United States corn and soybean production, 1998 -- 2020"
author: "Andrew R. Kniss"
date: "updated `r Sys.Date()`"
output: html_document
---

---

```{r setup, include = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
library("tidyverse")
library("cowplot")
library("readxl")
library("openxlsx")
library("plotly")
library("rcartocolor")
library("tidytext")

### Load Kynnetec AgroTrak pesticide data (proprietary):
AgroTrak.Timing.dat <- read_excel(
  "DATA/US AgroTrak Chemical Use Timing.xlsx",
  skip = 5) %>%
  select(Year, Crop,
         Timing0 = `Application Timing`,
         Type = `Pesticide Type`,
         Active.Ingredient = `Active Ingredient`,
         Volume.lbs = `AI volume\r\n(lb)`,
         Base.Area.Treated = `Base Area Treated\r\n(acres)`,
         Total.Area.Treated = `Total Area Treated\r\n(acres)`) %>%
  mutate(ai = str_replace_all(Active.Ingredient, " \\(.\\)", ""),
         Timing = case_when(
           Timing0 %in% c("At Planting", "Before Crop Emergence",
                          "Last Fall", "Prior to Planting") ~ "PRE",
           Timing0 %in% c("Early Post (Herbicides)", "Late Post (Herbicides)",
                          "Postemergence (Non-Herbicides)",
                          "Foliar atTasseling (Fungicides)", 
                          "Foliar before Tasseling (Fungicides)") ~ "POST"),
         Timing = factor(Timing, ordered = "TRUE",
                            levels = c("PRE", "POST"))) 
glimpse(AgroTrak.Timing.dat)

## Get full pesticide list from AgroTrak:
AgroTrak.aiList <- AgroTrak.Timing.dat %>%
  select(ai) %>%
  distinct()

### load Farruggia et al. (2022) tox data:
farruggia.s1.all <- read_excel("DATA/journal.pone.0265962.s001.xlsx",
                          sheet = "Supporting Table S1", 
                          skip = 7, 
                          col_names = c("Pesticide", "PCCODE", 
                                        "Type", "Class", "MOA", 
                                        "AAC.LD50", LETTERS[1:7])) %>%
  select(Pesticide:AAC.LD50) %>%
  mutate(ineq = ifelse(str_detect(AAC.LD50, ">"), ">", NA),
         AAC.LD50 = as.numeric(str_remove(AAC.LD50, ">")),
         ai = str_to_upper(Pesticide)) %>%
  mutate(source = "Farruggia et al. 2022") %>%
  select(ai, ineq, AAC.LD50, source)
glimpse(farruggia.s1.all)

### Load concordance file:
srcTab <- read_csv("DATA/cclistInEcotox.csv")
glimpse(srcTab)

### Load honey bee toxicity values from Ecotox export
ecotox.dat0 <- 
  read_excel("DATA/ECOTOX-Terrestrial-Export_20211207.xlsx",
             sheet = "Terrestrial-Export") %>%
  rename(cas.number = "CAS Number", chemName = "Chemical Name") %>%
  filter(`Species Scientific Name` == "Apis mellifera") %>%
  select(source, cas.number, chemName,
         Species = `Species Scientific Name`, 
         Lifestage = `Organism Lifestage`,
         ExposureType = `Exposure Type`, 
         concType = `Conc 1 Type (Author)`,
         Effect, Endpoint, ineq = `Observed Response Mean Op`,
         ObsRespMean = `Observed Response Mean`,
         ToxUnit = `Observed Response Units`,
         ObservedDuration.d = `Observed Duration (Days)`)
glimpse(ecotox.dat0)

### Join with the concordance list:
ecotox.dat1 <- ecotox.dat0 %>%
  filter(Lifestage == "Adult" &
           Endpoint == "LD50" & 
           ExposureType == "Dermal") %>%
  right_join(srcTab) %>%
  select(-inEcoTox, -inManualAdd, -ModeOfAction)
glimpse(ecotox.dat1) 

## SELECTION LOGIC for exported Ecotox data
## For ais with multiple adult acute dermal LD50 values in Ecotox:
## 1) if there is only one exact estimate use it (exclude > values)
## 2) if there are multiple exact estimates, use the lowest value
## 3) if there are no exact estimates, use the lowest > value (questionable...)
ecotox.select1 <- ecotox.dat1 %>%
  group_by(ai) %>%
  mutate(n.est = sum(is.na(ineq))) %>%
  filter(case_when(
    n.est == 1 ~ is.na(ineq), ## (1)
    n.est > 1 ~ is.na(ineq) & ObsRespMean == min(ObsRespMean), ## (2)
    n.est == 0 ~ ObsRespMean == min(ObsRespMean) ## (3)
  )) %>%
  select(ai, ineq, AAC.LD50 = ObsRespMean, source)
glimpse(ecotox.select1)

ecotox.dat2 <- left_join(ecotox.select1 %>% select(ai, 
                                                   eco.ineq = ineq,
                                                   eco.LD50 = AAC.LD50), 
                         farruggia.s1.all %>% select(ai,
                                                     far.ineq = ineq,
                                                     far.LD50 = AAC.LD50)) %>%
    mutate(same.LD50 = eco.LD50 == far.LD50,
           lower.LD50 = case_when(
           eco.LD50 - far.LD50 < 0 ~ "Ecotox",
           eco.LD50 - far.LD50 > 0 ~ "Farruggia",
           same.LD50 == TRUE ~ "Same")) %>%
    arrange(lower.LD50, eco.ineq)
glimpse(ecotox.dat2)
which.farruggia <- ecotox.dat2 %>%
  filter(lower.LD50 == "Farruggia") %>%
  select(ai)
which.farruggia

## Load manually searched tox values from PRA/ERA documents:
missingSearch.dat <- read_excel("DATA/MissingToxDataSearch.xlsx",
                                sheet = "MissingToxDataSearch",
                                range = cell_cols("A:F")) %>%
  select(ai, ineq, AAC.LD50, source)
glimpse(missingSearch.dat)

finalTox.dat <- bind_rows(
  ecotox.select1 %>% filter(!ai %in% which.farruggia$ai & 
                              !is.na(AAC.LD50)),
  farruggia.s1.all %>% filter(ai %in% which.farruggia$ai),
  missingSearch.dat %>% filter(!is.na(AAC.LD50))
)
glimpse(finalTox.dat)
write_csv(finalTox.dat, "finalToxData.csv")

## Merge with usage data
AgroTrak.ecotox <-
  AgroTrak.Timing.dat %>%
  left_join(finalTox.dat) %>%
  mutate(Year = as.numeric(Year),
         Volume.kg = Volume.lbs * 0.454,
         RQ = Volume.kg / AAC.LD50) 
glimpse(AgroTrak.ecotox)
```

# Data sources:

## Pesticide usage data

Proprietary pesticide usage data were obtained from [Kynetec](https://www.kynetec.com/). Data included the volume, treated acreage, and timing of pesticide applications for corn and soybean from 1998 through 2020. 

## Honey bee toxicity data

Adult acute contact $LD_{50}$ values for honey bee (*Apis mellifera*) were obtained from the following sources:

* The U.S. EPA [ECOTOX](https://cfpub.epa.gov/ecotox/) database.
* Supporting Table S1 from [Farruggia et al (2022)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0265962)
* Manually searching pesticide registration documents.

First, the ECOTOX database was exported and used as the preferred source for all pesticide toxicity data. For each active ingredient (ai) in the Kynetec data, adult acute contact $LD_{50}$ were downloaded. For ai with multiple values reported, we used the following selection criteria to select a single toxicity value:

1) if there was only one *exact* estimate (as opposed to an inequality) the exact estimate was selected.
2) if there were multiple exact estimates, the lowest (most toxic) value was selected.
3) if there were no exact estimates, the lowest (most toxic) inequality was selected. 

After this selection criteria was applied to the ECOTOX data, the selected toxicity values were compared with those published by Farruggia et al. (2022). In nearly all cases, the ECOTOX values were the same. For 6 pesticides, the values reported by Farruggia et al. were lower (*i.e.* more toxic) than those selected from ECOTOX; for those six pesticides, the Farruggia et al. values were used to ensure we used the most conservative toxicity estimates available. Finally, for any ai in the Kynetec data that did not have toxicity values in ECOTOX or Farruggia et al. (2022), pesticide registration documents were searched manually to obtain honey bee adult acute contact toxicity values. 

```{r, include = FALSE, warning = FALSE, message = FALSE}
missDat <- AgroTrak.ecotox %>%
  group_by(ai) %>%
  summarize(totalVol = signif(sum(Volume.kg), 3),
            totalBase = signif(sum(Base.Area.Treated), 3),
            AAC.LD50 = unique(AAC.LD50)) %>%
  filter(is.na(AAC.LD50) & totalVol > 1000) %>%
  arrange(desc(totalBase)) %>%
  select(ai, AAC.LD50, totalVol, totalBase) %>%
  data.frame()
goodDat <- AgroTrak.ecotox %>%
  group_by(ai) %>%
  summarize(AAC.LD50 = unique(AAC.LD50)) %>%
  filter(!is.na(AAC.LD50)) %>%
  select(ai)
```

In total, there were `r length(missDat$ai) + length(goodDat$ai)` unique pesticides in the Kynetec database applied to either corn or soybean during 1998 to 2020. Of those, we were unable to find a reliable toxicity estimate for `r length(missDat$ai)` pesticides (Table 1).

```{r, echo = FALSE, warning = FALSE, message = FALSE}
knitr::kable(missDat %>% select(-AAC.LD50),
             col.names = c("Active ingredient", 
                           "Total volume (kg)", 
                           "Total base acres treated"),
             caption = "**Table 1. Active ingredients for which more than 1,000 kg were applied during the period 1998 -- 2020 but do not have a reliable honey bee adult acute contact $LD_{50}$.**")
```

# Honey bee Risk Quotient

```{r, include = FALSE}
RQ.summary.yr <- AgroTrak.ecotox %>%
  group_by(Year, Crop, Timing, Type) %>%
  summarize(RQ = sum(RQ, na.rm = TRUE)/1000000)
RQ.summary <- AgroTrak.ecotox %>%
  group_by(Crop, Timing, Type) %>%
  summarize(RQ = sum(RQ, na.rm = TRUE)/1000000) %>%
  group_by(Crop) %>% 
  mutate(cropRQ = sum(RQ),
         cropRQ.pct = signif(RQ / cropRQ*100, 2))

RQ.cropTotals <- RQ.summary %>% 
  group_by(Crop) %>% 
  summarize(cropRQ = unique(cropRQ)) %>%
  pivot_wider(names_from = Crop, values_from = cropRQ) %>%
  mutate(propDiff = Corn / Soybeans)

cropType.summary <- RQ.summary %>% 
  group_by(Crop, Type) %>%
  summarize(cropRQ.pct = sum(cropRQ.pct))
```

Pesticide use data were separated into pesticides applied before crop emergence (PRE) and pesticides applied after crop emergence (POST). For each ai applied to each crop in each year, the volume applied $P_{vol}$ in kg was divided by the acute contact $LD_{50}$ for adult honey bees expressed in $\mu$g / bee to derive a risk quotient (RQ). [this was also divided by 1 million solely to make numbers easier to read in the figs... probably need to discuss that choice.]

$$RQ = (\frac{P_{vol}}{LD_{50}}) * 10^{-6}$$

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 3, fig.cap = "**Figure 1. Summed honey bee RQ applied to corn or soybean during the period 1998 through 2020 by pesticide type and application timing.**"}
ggplot(RQ.summary, 
       aes(x = RQ, y = Type)) +
  facet_grid(Crop ~ Timing) + 
  geom_bar(stat = "identity",
           aes(fill = Crop)) +
  ylab(element_blank()) +
  xlab("Honeybee acute RQ") +
  theme_minimal_grid() +
  theme(legend.position = "none")
```

* The summed honey bee RQ over all years was `r round(RQ.cropTotals$propDiff, 1)`-times greater in corn compared to soybean.  
* `r cornTot <- RQ.summary %>% filter(Crop == "Corn" & Timing == "PRE") %>% summarize(a = sum(cropRQ.pct))
round(cornTot[[2]])`% of the summed honey bee risk quotient applied to corn was applied *before* crop emergence, when relative risk to honey bees and many other pollinator species is expected to be lower. 
* `r soyTot <- RQ.summary %>% filter(Crop == "Soybeans" & Timing == "POST") %>% summarize(a = sum(cropRQ.pct))
round(soyTot[[2]])`% of the summed honey bee risk quotient applied to soybean was applied *after* crop emergence, when relative risk to honey bees and many other pollinator species is expected to be higher.
* In corn, insecticides were responsible for `r corn.i <- cropType.summary %>% filter(Crop == "Corn" & Type == "Insecticide")
corn.i[[3]]`% of the summed RQ, compared to `r corn.h <- cropType.summary %>% filter(Crop == "Corn" & Type == "Herbicide")
corn.h[[3]]`% for herbicides, and `r corn.f <- cropType.summary %>% filter(Crop == "Corn" & Type == "Fungicide")
corn.f[[3]]`% for fungicides.
* In soybean, insecticides were responsible for `r soy.i <- cropType.summary %>% filter(Crop == "Soybeans" & Type == "Insecticide")
soy.i[[3]]`% of the summed RQ, compared to `r soy.h <- cropType.summary %>% filter(Crop == "Soybeans" & Type == "Herbicide")
soy.h[[3]]`% for herbicides, and `r soy.f <- cropType.summary %>% filter(Crop == "Soybeans" & Type == "Fungicide")
soy.f[[3]]`% for fungicides.

---

```{r, include = FALSE, warning = FALSE, message = FALSE}
options(scipen = 10)
knitr::kable(RQ.summary %>% select(-cropRQ) %>%
               pivot_wider(id_cols = c(Type, Timing),
                           names_from = Crop,
                           values_from = cropRQ.pct) %>%
               arrange(Timing, Type),
             caption = "**Table 2. Percentage of the total honey bee risk quotient in corn and soybean by pesticide type and application timing.**")
```




```{r, echo = FALSE, warning = FALSE, message = FALSE}
RQ.plot <- function(data = RQ.summary.yr, crop, timing, excludeType = "none") {
  data %>% filter(Crop == crop & Timing == timing & Type != excludeType) %>%
    ggplot(aes(y = RQ, x = Year)) +
    facet_wrap(~ Type, scales = "free_y",
               ncol = 1) +
    geom_point() + 
    stat_smooth(se = FALSE, span = 0.9) +
    ylab("Honeybee acute RQ") +
    #theme_minimal_hgrid() +
    theme_gray(base_size = 18) +
    scale_y_continuous(limits = c(0, NA), expand = c(0, 0)) +
    ggtitle(paste(crop, timing))
}
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 6, fig.cap = "**Figure 2. Honey bee adult acute contact risk quotient for pesticides applied to corn or soybean *before* crop emergence.**"}
plot_grid(RQ.plot(crop = "Corn", timing = "PRE", excludeType = "Fungicide"),
          RQ.plot(crop = "Soybeans", timing = "PRE", excludeType = "Fungicide"),
          nrow = 1)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 9, fig.cap = "**Figure 3. Honey bee adult acute contact risk quotient for pesticides applied to corn or soybean *after* crop emergence.**"}
plot_grid(RQ.plot(crop = "Corn", timing = "POST"),
          RQ.plot(crop = "Soybeans", timing = "POST"),
          nrow = 1)
```
